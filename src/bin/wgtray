#!/bin/bash
set -euo pipefail

LIBDIR="/usr/lib/wgtray"
[[ -d "$LIBDIR" ]] || LIBDIR="$(dirname "$0")/../lib"

# Load constants
CONSTANTS="/usr/share/wgtray/constants.conf"
[[ -f "$CONSTANTS" ]] || CONSTANTS="$(dirname "$0")/../res/constants.conf"
source "$CONSTANTS"

print_help() {
    cat <<EOF
wgtray $VERSION - WireGuard system tray client

Usage: wgtray [OPTIONS]

Options:
  -h, --help              Show this help message
  -v, --version           Show version
  -d, --debug             Enable debug output
  --status                Show autostart status
  --enable-xdg            Enable XDG autostart (Desktop Environments)
  --enable-systemd        Enable systemd autostart (Window Managers)
  --disable               Disable autostart
  --hook <iface> <event>  Create/edit hook script
  --list-hooks            List all hooks
  --remove-hook <i> <e>   Remove a hook
EOF
}

case "${1:-}" in
    -h|--help)
        print_help
        ;;
    -v|--version)
        echo "wgtray $VERSION"
        ;;
    --status)
        "$LIBDIR/autostart.sh" --get | xargs -I{} echo "Autostart: {}"
        ;;
    --enable-xdg)
        "$LIBDIR/autostart.sh" --enable-xdg
        ;;
    --enable-systemd)
        "$LIBDIR/autostart.sh" --enable-systemd
        ;;
    --disable)
        "$LIBDIR/autostart.sh" --disable
        ;;
    --hook)
        "$LIBDIR/hooks.sh" --create "${2:-}" "${3:-}"
        ;;
    --list-hooks)
        "$LIBDIR/hooks.sh" --list
        ;;
    --remove-hook)
        "$LIBDIR/hooks.sh" --remove "${2:-}" "${3:-}"
        ;;
    -d|--debug)
        exec python3 -m wgtray --debug
        ;;
    "")
        exec python3 -m wgtray
        ;;
    *)
        echo "Unknown option: $1" >&2
        echo "Run 'wgtray --help' for usage" >&2
        exit 1
        ;;
esac